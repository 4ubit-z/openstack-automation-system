# OpenStack Provider 인증 구성 가이드

Terraform이 OpenStack API와 통신할 수 있도록 인증 정보를 구성하는 단계

## 작업 개요

| 항목 | 내용 |
|------|------|
| 인증 방식 | `clouds.yaml` (Terraform 권장 방식) |
| 위치 | `~/.config/openstack/clouds.yaml` 또는 프로젝트별 설정 |
| 적용 대상 | Terraform provider "openstack" 설정 시 `cloud = "devstack"`으로 사용됨 |

## 작업 단계

### 1. Guest VM 환경에서 인증 정보 확인

```bash
cat /opt/stack/devstack/openrc
```

`OS_USERNAME`, `OS_PASSWORD`, `OS_AUTH_URL`, `OS_PROJECT_NAME` 등 확인

### 2. 인증 파일 디렉토리 및 파일 생성

```bash
mkdir -p ~/.config/openstack
vim ~/.config/openstack/clouds.yaml
```

### 3. clouds.yaml 작성

```yaml
clouds:
  devstack:
    auth:
      auth_url: http://a.b.c.d/identity
      username: admin
      password: secretopenstack
      project_name: admin
      user_domain_name: Default
      project_domain_name: Default
    region_name: RegionOne
    interface: public
    identity_api_version: 3
```

**설정 참고사항**:
- IP 주소 및 비밀번호는 본인의 DevStack 환경에 맞게 수정
- `auth_url`은 Horizon 접속 주소에서 `/dashboard` → `/identity`로 변경하여 사용

### 4. 인증 테스트

```bash
openstack --os-cloud devstack server list
```

- 아무 출력이 없으면 **정상** (인스턴스가 없다는 뜻)
- 인증 오류가 있다면 에러 메시지 출력됨

**추가 확인 명령어**:

```bash
openstack --os-cloud devstack project show admin
openstack --os-cloud devstack image list
openstack --os-cloud devstack network list
```

## 인증 파일 관리 방법

### 방법 A) 환경 변수로 경로 고정 (권장)

clouds.yaml을 프로젝트 폴더에 보관하고 환경변수로 경로를 지정함. Terraform OpenStack provider는 `OS_CLIENT_CONFIG_FILE`을 인식해서 해당 경로의 clouds.yaml을 사용함.

**프로젝트에 파일 배치**:

```bash
mkdir -p ~/git_1/terraform/.secrets
cp ~/.config/openstack/clouds.yaml ~/git_1/terraform/.secrets/clouds.yaml
chmod 600 ~/git_1/terraform/.secrets/clouds.yaml
```

**환경변수 설정 (한 번만 설정)**:

```bash
echo 'export OS_CLIENT_CONFIG_FILE="$HOME/git_1/terraform/.secrets/clouds.yaml"' >> ~/.bashrc
echo 'export OS_CLOUD="devstack"' >> ~/.bashrc
source ~/.bashrc
```

**providers.tf 설정**:

```hcl
provider "openstack" {
  cloud = "devstack"
}
```

이 방법의 장점:
- unstack/stack를 반복해도 Terraform이 항상 프로젝트 내부의 clouds.yaml을 사용함
- 프로젝트별로 다른 인증 정보 관리 가능
- sudo 사용 시에는 `sudo -E` 옵션으로 환경변수 전달 필요

### 방법 B) 표준 위치 사용

기본 설정대로 `~/.config/openstack/clouds.yaml`을 사용함.

```bash
mkdir -p ~/.config/openstack
vim ~/.config/openstack/clouds.yaml
```

## 문제 해결

### 인증 실패 시 확인사항

```bash
# openrc 파일에서 정확한 정보 확인
source /opt/stack/devstack/openrc admin
env | grep OS_

# OpenStack 서비스 상태 확인
sudo systemctl status devstack@*
```

### clouds.yaml 권한 설정

```bash
chmod 600 ~/.config/openstack/clouds.yaml
# 또는 프로젝트 경로의 경우
chmod 600 ~/git_1/terraform/.secrets/clouds.yaml
```

### 환경변수 확인

```bash
# 현재 설정된 환경변수 확인
echo $OS_CLIENT_CONFIG_FILE
echo $OS_CLOUD

# 환경변수가 적용되었는지 테스트
openstack server list
```

**참고**: 인증 설정이 완료되면 Terraform에서 `cloud = "devstack"` 설정으로 OpenStack 리소스 관리가 가능함.
