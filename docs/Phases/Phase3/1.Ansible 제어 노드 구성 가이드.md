# Ansible 제어 노드 구성 가이드

게스트 VM을 Ansible 제어 노드로 구성하여 OpenStack VM들을 관리할 수 있도록 설정

## 목표

게스트 VM을 Ansible 제어 노드로 구성하고 OpenStack VM과의 연결 테스트 수행

## 구성 개요

### 제어 노드 (Ansible 실행하는 쪽)

| 항목 | 내용 |
|------|------|
| 위치 | 게스트 VM (Ubuntu) |
| 역할 | Ansible을 설치하고 playbook 실행 |
| 접속 방식 | SSH Key (`open.pem`) 이용 |
| 작업 디렉터리 | `~/ansible-test/` |

### 대상 노드 (Ansible이 관리할 VM)

| 항목 | 내용 |
|------|------|
| 위치 | OpenStack에서 생성한 Ubuntu VM |
| 역할 | 웹서버(nginx), Jenkins, 사용자 설정 등을 적용받을 대상 |
| IP | `a.b.c.d` (Floating IP) |
| 기본 사용자 | `ubuntu` |
| 접속 방식 | `.pem` 키를 통한 SSH 인증 |

### 디렉터리 구조

```
~/ansible-test/
├── inventory.ini     # 대상 노드 정보
├── open.pem         # SSH 키
├── nginx.yml        # 웹서버 설치용 플레이북
└── jenkins.yml      # Jenkins 설치용 플레이북 (추후)
```

## 1단계: Ansible 설치

제어 노드로 사용할 게스트 VM에 Ansible 설치:

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y ansible
```

설치 확인:

```bash
ansible --version
```

## 2단계: 인벤토리 파일 작성

### 작업 디렉토리 생성

```bash
mkdir -p ~/ansible-test && cd ~/ansible-test
```

### inventory.ini 파일 생성

```bash
touch inventory.ini
```

**inventory.ini 파일 내용**:

```ini
[web]
a.b.c.d ansible_user=ubuntu ansible_ssh_private_key_file=./open.pem
```

**설정 설명**:
- `web` 그룹은 웹서버 설치 자동화의 대상
- 향후 Jenkins 설치 시 `jenkins` 그룹으로 확장 가능
- `a.b.c.d`: 대상 VM의 Floating IP
- `ansible_user`: Ubuntu 이미지인 경우 보통 `ubuntu`
- `ansible_ssh_private_key_file`: SSH 키 파일 경로 (상대경로)

## 3단계: SSH 키 연결 확인

제어 노드(게스트 VM)에서 대상 노드(OpenStack VM)로 직접 SSH 접속 테스트:

```bash
ssh -i /opt/stack/devstack/open.pem ubuntu@a.b.c.d
```

**결과 확인**:
- 정상 접속되면 인증 문제 없음
- 접속 안 될 경우: 권한 문제, 보안 그룹, 사용자 이름 다시 확인

## 4단계: 기본 Ansible 테스트

작업 디렉토리에서 Ansible 테스트 명령 실행:

```bash
ansible -i inventory.ini web -m ping
```

**정상 응답 예시**:

```yaml
a.b.c.d | SUCCESS => {
    "changed": false,
    "ping": "pong"
}
```

## 문제 해결

### SSH 접속 문제

```bash
# 키 파일 권한 확인
ls -l /opt/stack/devstack/open.pem

# known_hosts 파일 정리 (필요시)
ssh-keygen -f "/home/stack/.ssh/known_hosts" -R "a.b.c.d"
```

### Ansible 연결 문제

```bash
# 상세 로그로 디버깅
ansible -i inventory.ini web -m ping -vvv

# 직접 SSH 테스트
ssh -i /opt/stack/devstack/open.pem ubuntu@a.b.c.d
```

---

**참고**: Ansible 제어 노드 구성이 완료되면 다음 단계에서 Playbook을 작성하여 자동화 작업을 진행할 예정
