# Alertmanager 설치 및 알림 규칙 설정 가이드

## 목표

Prometheus와 연동하여 시스템 모니터링 알림을 관리하는 Alertmanager를 설치하고, 기본 알림 규칙을 적용함.

## 아키텍처 및 포트 구성

```
[DevStack Host]
├── Prometheus :9091     ← 메트릭 수집
├── Grafana    :3000     ← 대시보드
├── Alertmanager :9096   ← 알림 관리 (cluster :9097)
└── ↓ 모니터링 대상
    [OpenStack VMs]
    └── Node Exporter :9100  (예: 221.157.174.34:9100)
```

**참고**: GitLab 내장 서비스들이 표준 포트(9090/9093)를 사용하므로 커스텀 포트 사용

## Alertmanager 설치

```bash
sudo apt update
sudo apt install -y prometheus-alertmanager
```

## 기본 설정 파일 구성

### 최소 설정 (devnull 리시버)

`/etc/alertmanager/alertmanager.yml`

```yaml
route:
  receiver: "devnull"
  group_by: ["alertname","instance"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 2h

receivers:
  - name: "devnull"
```

## 포트 충돌 회피 설정

GitLab 내장 Alertmanager가 9093/9094 포트를 사용할 수 있으므로 9096/9097 포트로 변경함.

### 포트 설정 변경

```bash
sudo tee /etc/default/prometheus-alertmanager >/dev/null <<'EOF'
ARGS="--config.file=/etc/alertmanager/alertmanager.yml --storage.path=/var/lib/alertmanager --web.listen-address=0.0.0.0:9096 --cluster.listen-address=0.0.0.0:9097"
EOF
sudo chown -R prometheus:prometheus /etc/alertmanager /var/lib/alertmanager
sudo systemctl daemon-reload
sudo systemctl enable --now prometheus-alertmanager
```

## Alertmanager 동작 확인

```bash
sudo ss -lntp | egrep ':9096|:9097'
curl -s http://localhost:9096/-/ready
```

- Alertmanager UI: `http://<HOST_IP>:9096`

## Prometheus와 Alertmanager 연동

### Prometheus 설정 업데이트

`/etc/prometheus/prometheus.yml`에 다음 섹션 추가:

```yaml
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9096']   # Alertmanager 포트

rule_files:
  - /etc/prometheus/rules/*.yml
```

### 알림 규칙 파일 생성

```bash
sudo mkdir -p /etc/prometheus/rules
sudo tee /etc/prometheus/rules/node-alerts.yml >/dev/null <<'YML'
groups:
- name: node-basics
  rules:
  - alert: NodeDown
    expr: up{job="nodes"} == 0
    for: 1m
    labels: {severity: critical}
    annotations:
      summary: "Node down: {{ $labels.instance }}"

  - alert: HighCPU
    expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{job="nodes",mode="idle"}[5m])) * 100) > 85
    for: 5m
    labels: {severity: warning}
    annotations:
      summary: "High CPU on {{ $labels.instance }}"
YML
```

### 규칙 검증 및 적용

```bash
sudo promtool check rules /etc/prometheus/rules/node-alerts.yml
sudo systemctl reload prometheus || sudo systemctl restart prometheus
```

## 알림 테스트

### NodeDown 알림 테스트 시나리오

```bash
# 대상 VM에서 Node Exporter 중지하여 NodeDown 알림 발생
sudo systemctl stop node_exporter

# 1~2분 후 Alertmanager UI(9096)에서 firing 상태 확인

# Node Exporter 재시작으로 알림 해제 확인
sudo systemctl start node_exporter
```

## 알림 규칙 설명

### NodeDown 알림
- **조건**: Node Exporter가 1분간 응답하지 않을 때
- **심각도**: critical
- **용도**: 서버 다운 또는 네트워크 장애 감지

### HighCPU 알림  
- **조건**: CPU 사용률이 85%를 5분간 초과할 때
- **심각도**: warning
- **용도**: 시스템 과부하 상태 감지

## 검증 포인트

1. **서비스 상태**: `systemctl status prometheus-alertmanager`
2. **포트 리스닝**: `ss -lntp | grep :9096`
3. **웹 인터페이스**: `http://<HOST_IP>:9096` 접속 가능
4. **Prometheus 연동**: Prometheus UI에서 Alerts 탭 확인
5. **알림 발생**: 테스트 시나리오로 알림 동작 검증

이제 시스템 모니터링에 대한 기본적인 알림 체계가 구축됨.
