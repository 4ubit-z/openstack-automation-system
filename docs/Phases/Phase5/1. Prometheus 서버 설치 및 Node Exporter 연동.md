Phase 5-1: Prometheus 서버 설치 및 Node Exporter 연동 (VM 모니터링 대상)
🎯 목표

OpenStack 위에 Prometheus 서버를 설치한다. (DevStack Host에 설치)

모니터링 대상은 각 OpenStack VM (예: Jenkins VM, Nginx VM 등)이다.

VM 내부에 Node Exporter를 설치해서 OS/자원 상태(CPU, RAM, Disk, Network)를 Prometheus가 수집하도록 구성한다.

📂 디렉터리 구조 (Phase 5 추가)
repo-root/
├─ terraform/
│  ├─ main.tf
│  ├─ variables.tf
│  ├─ outputs.tf
│  └─ ...
├─ ansible/
│  ├─ hosts-fix.yml
│  ├─ nginx.yml
│  ├─ jenkins.yml
│  └─ monitoring.yml        # VM 대상 Node Exporter 설치용
└─ .gitlab-ci.yml


※ Prometheus 서버는 DevStack Host에 직접 설치하므로 Terraform 리소스는 추가하지 않습니다.
※ 모니터링 대상 VM에는 Ansible로 Node Exporter만 설치합니다.

🛠️ Prometheus 서버 설치 (DevStack Host)
설치 스크립트 예시
# Prometheus 설치
PROM_VERSION="2.54.1"
wget https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz
tar -xzf prometheus-${PROM_VERSION}.linux-amd64.tar.gz
sudo mv prometheus-${PROM_VERSION}.linux-amd64 /opt/prometheus

# 실행 (9090 포트)
nohup /opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --web.listen-address=:9090 &

📦 Ansible Playbook (ansible/monitoring.yml)

이 플레이북은 대상 VM에 Node Exporter를 설치합니다.
Prometheus 서버는 DevStack Host에 있으므로, Prometheus가 각 VM의 9100 포트로 접속해 메트릭을 수집합니다.

---
- name: Install Node Exporter on VM
  hosts: all
  become: yes
  vars:
    ansible_user: ubuntu
    ansible_python_interpreter: /usr/bin/python3
    node_exporter_version: "1.8.1"

  tasks:
    - name: Download Node Exporter
      get_url:
        url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        dest: /tmp/node_exporter.tar.gz

    - name: Extract Node Exporter
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Symlink Node Exporter binary
      file:
        src: "/opt/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
        dest: "/usr/local/bin/node_exporter"
        state: link

    - name: Run Node Exporter
      shell: "nohup node_exporter --web.listen-address=:9100 &"

⚙️ Prometheus 설정 (DevStack Host, /opt/prometheus/prometheus.yml)
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "nodes"
    static_configs:
      - targets: ["<jenkins_vm_ip>:9100", "<nginx_vm_ip>:9100"]


※ <jenkins_vm_ip>, <nginx_vm_ip> 는 Terraform Output에서 가져와 직접 추가.
※ 나중에는 CI에서 자동으로 Prometheus 설정 업데이트하도록 확장 가능.

🔗 GitLab CI 연동 (.gitlab-ci.yml 일부)

Node Exporter 설치를 Ansible job으로 추가:

tf:ansible:monitoring:
  stage: config
  needs: ["tf:apply"]
  script:
    - source target_ip.env
    - ssh-keyscan -H "$TARGET_IP" >> ~/.ssh/known_hosts || true
    - ansible-playbook -i "${TARGET_IP}," -u ubuntu --private-key ~/.ssh/ansible_key ansible/monitoring.yml

✅ 검증

VM에서 Node Exporter 확인

브라우저 접속: http://<vm_ip>:9100/metrics

텍스트로 CPU, RAM, Disk 등 메트릭 출력 확인

Prometheus 서버 확인 (DevStack Host)

브라우저 접속: http://<host_ip>:9090

Status → Targets 메뉴에서 <vm_ip>:9100 상태가 UP 인지 확인
