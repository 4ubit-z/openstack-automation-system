Phase 5-1: Prometheus ì„œë²„ ì„¤ì¹˜ ë° Node Exporter ì—°ë™ (VM ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ)
ğŸ¯ ëª©í‘œ

OpenStack ìœ„ì— Prometheus ì„œë²„ë¥¼ ì„¤ì¹˜í•œë‹¤. (DevStack Hostì— ì„¤ì¹˜)

ëª¨ë‹ˆí„°ë§ ëŒ€ìƒì€ ê° OpenStack VM (ì˜ˆ: Jenkins VM, Nginx VM ë“±)ì´ë‹¤.

VM ë‚´ë¶€ì— Node Exporterë¥¼ ì„¤ì¹˜í•´ì„œ OS/ìì› ìƒíƒœ(CPU, RAM, Disk, Network)ë¥¼ Prometheusê°€ ìˆ˜ì§‘í•˜ë„ë¡ êµ¬ì„±í•œë‹¤.

ğŸ“‚ ë””ë ‰í„°ë¦¬ êµ¬ì¡° (Phase 5 ì¶”ê°€)
repo-root/
â”œâ”€ terraform/
â”‚  â”œâ”€ main.tf
â”‚  â”œâ”€ variables.tf
â”‚  â”œâ”€ outputs.tf
â”‚  â””â”€ ...
â”œâ”€ ansible/
â”‚  â”œâ”€ hosts-fix.yml
â”‚  â”œâ”€ nginx.yml
â”‚  â”œâ”€ jenkins.yml
â”‚  â””â”€ monitoring.yml        # VM ëŒ€ìƒ Node Exporter ì„¤ì¹˜ìš©
â””â”€ .gitlab-ci.yml


â€» Prometheus ì„œë²„ëŠ” DevStack Hostì— ì§ì ‘ ì„¤ì¹˜í•˜ë¯€ë¡œ Terraform ë¦¬ì†ŒìŠ¤ëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
â€» ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ VMì—ëŠ” Ansibleë¡œ Node Exporterë§Œ ì„¤ì¹˜í•©ë‹ˆë‹¤.

ğŸ› ï¸ Prometheus ì„œë²„ ì„¤ì¹˜ (DevStack Host)
ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ
# Prometheus ì„¤ì¹˜
PROM_VERSION="2.54.1"
wget https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz
tar -xzf prometheus-${PROM_VERSION}.linux-amd64.tar.gz
sudo mv prometheus-${PROM_VERSION}.linux-amd64 /opt/prometheus

# ì‹¤í–‰ (9090 í¬íŠ¸)
nohup /opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --web.listen-address=:9090 &

ğŸ“¦ Ansible Playbook (ansible/monitoring.yml)

ì´ í”Œë ˆì´ë¶ì€ ëŒ€ìƒ VMì— Node Exporterë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
Prometheus ì„œë²„ëŠ” DevStack Hostì— ìˆìœ¼ë¯€ë¡œ, Prometheusê°€ ê° VMì˜ 9100 í¬íŠ¸ë¡œ ì ‘ì†í•´ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

---
- name: Install Node Exporter on VM
  hosts: all
  become: yes
  vars:
    ansible_user: ubuntu
    ansible_python_interpreter: /usr/bin/python3
    node_exporter_version: "1.8.1"

  tasks:
    - name: Download Node Exporter
      get_url:
        url: "https://github.com/prometheus/node_exporter/releases/download/v{{ node_exporter_version }}/node_exporter-{{ node_exporter_version }}.linux-amd64.tar.gz"
        dest: /tmp/node_exporter.tar.gz

    - name: Extract Node Exporter
      unarchive:
        src: /tmp/node_exporter.tar.gz
        dest: /opt/
        remote_src: yes

    - name: Symlink Node Exporter binary
      file:
        src: "/opt/node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"
        dest: "/usr/local/bin/node_exporter"
        state: link

    - name: Run Node Exporter
      shell: "nohup node_exporter --web.listen-address=:9100 &"

âš™ï¸ Prometheus ì„¤ì • (DevStack Host, /opt/prometheus/prometheus.yml)
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  - job_name: "nodes"
    static_configs:
      - targets: ["<jenkins_vm_ip>:9100", "<nginx_vm_ip>:9100"]


â€» <jenkins_vm_ip>, <nginx_vm_ip> ëŠ” Terraform Outputì—ì„œ ê°€ì ¸ì™€ ì§ì ‘ ì¶”ê°€.
â€» ë‚˜ì¤‘ì—ëŠ” CIì—ì„œ ìë™ìœ¼ë¡œ Prometheus ì„¤ì • ì—…ë°ì´íŠ¸í•˜ë„ë¡ í™•ì¥ ê°€ëŠ¥.

ğŸ”— GitLab CI ì—°ë™ (.gitlab-ci.yml ì¼ë¶€)

Node Exporter ì„¤ì¹˜ë¥¼ Ansible jobìœ¼ë¡œ ì¶”ê°€:

tf:ansible:monitoring:
  stage: config
  needs: ["tf:apply"]
  script:
    - source target_ip.env
    - ssh-keyscan -H "$TARGET_IP" >> ~/.ssh/known_hosts || true
    - ansible-playbook -i "${TARGET_IP}," -u ubuntu --private-key ~/.ssh/ansible_key ansible/monitoring.yml

âœ… ê²€ì¦

VMì—ì„œ Node Exporter í™•ì¸

ë¸Œë¼ìš°ì € ì ‘ì†: http://<vm_ip>:9100/metrics

í…ìŠ¤íŠ¸ë¡œ CPU, RAM, Disk ë“± ë©”íŠ¸ë¦­ ì¶œë ¥ í™•ì¸

Prometheus ì„œë²„ í™•ì¸ (DevStack Host)

ë¸Œë¼ìš°ì € ì ‘ì†: http://<host_ip>:9090

Status â†’ Targets ë©”ë‰´ì—ì„œ <vm_ip>:9100 ìƒíƒœê°€ UP ì¸ì§€ í™•ì¸
