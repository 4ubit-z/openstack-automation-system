# Grafana 설치 및 Prometheus 연동 가이드

## 목표

DevStack Host에 Grafana를 설치하고 Prometheus와 연동하여 VM 모니터링 대시보드를 구성함. Node Exporter Full 대시보드를 임포트하여 VM 지표를 시각화함.

## 전제 조건

- Prometheus가 `http://localhost:9091/-/ready`에서 Ready 상태
- 모니터링 대상 VM에 Node Exporter(9100) 동작 중
- VM 보안그룹에서 9100 포트 인바운드 허용
- Grafana 3000 포트 접근 가능

**참고**: GitLab 내장 Prometheus가 9090 포트를 사용하므로 프로젝트 Prometheus는 9091 포트로 운영

## Grafana 설치

### Ubuntu 패키지 저장소 등록

```bash
sudo apt update
sudo apt install -y software-properties-common curl gnupg

# 저장소/키 등록
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://packages.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://packages.grafana.com/oss/deb stable main" \
  | sudo tee /etc/apt/sources.list.d/grafana.list
```

### 설치 및 서비스 시작

```bash
# 설치 & 서비스 시작
sudo apt update
sudo apt install -y grafana
sudo systemctl enable --now grafana-server
sudo systemctl status grafana-server --no-pager
```

### 설치 확인

```bash
ss -lntp | grep :3000
curl -sI http://localhost:3000 | head
```

**포트 충돌 해결**: `/etc/grafana/grafana.ini`의 `http_port` 값을 3001 등으로 변경 후 재시작

## Prometheus 데이터 소스 등록

### 웹 인터페이스 접속 및 설정

1. 브라우저에서 `http://<DevStack Host IP>:3000` 접속
2. 초기 로그인: `admin / admin` → 비밀번호 변경
3. **Connections → Data sources → Add data source → Prometheus** 선택
4. **URL**: `http://localhost:9091` 입력 (동일 호스트)
5. **Save & test** 클릭하여 연결 확인 (Successful 메시지 확인)

## 대시보드 임포트

### Node Exporter Full 대시보드 설정

1. **Dashboards → New → Import** 선택
2. **Import via grafana.com**에 ID `1860` 입력 → **Load**
3. 데이터 소스로 위에서 생성한 **Prometheus** 선택 → **Import**
4. 상단 변수 **Instance**에서 모니터링할 VM (`x.x.x.x:9100`) 선택

### 대시보드 최적화 설정

- 우측 상단 시간 범위를 **Last 15m**로 설정
- **Auto-refresh**를 **5s** 또는 **10s**로 설정

## 헬스 체크 및 검증

### 서비스 상태 확인

```bash
# Prometheus 준비 상태
curl -s http://localhost:9091/-/ready

# Node Exporter 메트릭(원격 VM)
curl -s http://<VM_IP>:9100/metrics | head
```

### 대시보드 검증

- Grafana 대시보드에서 **CPU/메모리/네트워크/디스크** 패널에 값이 표시되는지 확인
- Prometheus UI(`http://localhost:9091/targets`)에서 `prometheus`, `nodes` 모두 **UP** 상태 확인

## 트러블슈팅

### 일반적인 문제 해결

**3000 포트 접속 불가**
- `systemctl status grafana-server` 서비스 상태 확인
- `ss -lntp | grep :3000` 포트 리스닝 확인  
- UFW/보안그룹 설정 확인

**데이터 소스 연결 실패**
- `curl -s http://localhost:9091/-/ready` Prometheus 상태 확인
- Prometheus가 9091 포트에서 리스닝 중인지 확인

**대시보드에 데이터 없음**
- Prometheus Targets 화면에서 `nodes` 상태가 **UP**인지 확인
- 시간 범위 및 Auto-refresh 설정 조정
- VM의 Node Exporter 서비스 상태 확인

## 완성된 모니터링 스택

```
[DevStack Host]
├── Prometheus :9091     ← 메트릭 수집
├── Grafana :3000        ← 시각화 대시보드
└── ↓ 모니터링 대상
    [OpenStack VMs]
    └── Node Exporter :9100  ← 시스템 메트릭 노출
```

이제 Grafana 대시보드를 통해 VM들의 CPU, 메모리, 디스크, 네트워크 사용률을 실시간으로 모니터링할 수 있음.
