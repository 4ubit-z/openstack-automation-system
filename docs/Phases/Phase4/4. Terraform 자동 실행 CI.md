# Terraform CI 파이프라인 구성 가이드

**목적**: 코드 변경 → GitLab CI → Terraform 자동 실행  
**범위**: `terraform/`만 대상으로 **plan / apply / destroy** 구성 (Ansible 제외)

## 전제 조건

### 필수 환경
- GitLab CE 동작 중 (예: `http://a.b.c.d:8081`)
- Shell Runner 등록 및 동작 확인 완료
- OpenStack 환경 구성 완료

### 프로젝트 구조
```
/
├─ ansible-test/         # (4-5에서 사용)
├─ terraform/            # ← Terraform 코드 (대상 폴더)
├─ .gitlab-ci.yml        # 파이프라인 정의
└─ (루트에 inventory/플레이북 몇 개 존재)
```

### Runner OpenStack 인증 준비

**방법 1: clouds.yaml 파일**
```bash
# gitlab-runner 사용자 홈 디렉토리에 설정
sudo -u gitlab-runner mkdir -p ~/.config/openstack
sudo cp ~/.config/openstack/clouds.yaml ~gitlab-runner/.config/openstack/
sudo chown gitlab-runner:gitlab-runner ~gitlab-runner/.config/openstack/clouds.yaml
sudo chmod 600 ~gitlab-runner/.config/openstack/clouds.yaml
```

**방법 2: GitLab CI/CD Variables**
- GitLab → Settings → CI/CD → Variables에서 OpenStack 인증 변수 등록

**권장: 원격 state 사용**
- `terraform/backend.tf`로 원격 state 구성 (state 분실 방지)

## 실행 전략

| 브랜치 | 조건 | 동작 |
|--------|------|------|
| `dev` | `terraform/` 변경 시 | **plan 자동 실행** |
| `main` | `terraform/` 변경 시 | **apply 수동 승인** |
| 모든 브랜치 | 수동 실행 | **destroy 수동 실행** |

## .gitlab-ci.yml 구성

### 기본 설정
```yaml
stages: [plan, apply, destroy]

variables:
  TF_WORKDIR: "terraform"
```

### Plan 스테이지 (개발용)
```yaml
# dev에서 terraform/ 변경 시 plan 자동
tf:plan:
  stage: plan
  script:
    - cd "$TF_WORKDIR"
    - terraform -version
    - terraform init -input=false
    # 0: no changes, 2: changes, 1: error
    - terraform plan -input=false -detailed-exitcode -out=tfplan || export TF_EXIT=$?
    - if [ "${TF_EXIT:-0}" = "1" ]; then echo "terraform plan error"; exit 1; fi
    - if [ "${TF_EXIT:-0}" = "0" ]; then echo "No changes"; exit 0; fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
      changes:
        - "terraform/**/*"
    - when: never
  artifacts:
    paths: [ "terraform/tfplan" ]
    expire_in: 1 day
```

### Apply 스테이지 (운영용)
```yaml
# main에서만 apply(수동). dev의 tfplan 아티팩트가 없으면 일반 apply 수행
tf:apply:
  stage: apply
  script:
    - cd "$TF_WORKDIR"
    - terraform -version
    - terraform init -input=false
    - |
      if [ -f tfplan ]; then
        echo "Using tfplan artifact"
        terraform apply -input=false -auto-approve tfplan
      else
        echo "No tfplan found — running apply directly"
        terraform apply -input=false -auto-approve
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: false
      changes:
        - "terraform/**/*"
    - when: never
  environment:
    name: production
    # Environments Stop 버튼과 연결하려면 아래 주석 해제
    # on_stop: tf:destroy
```

### Destroy 스테이지 (삭제용)
```yaml
# 항상 수동으로 전체 삭제
tf:destroy:
  stage: destroy
  script:
    - cd "$TF_WORKDIR"
    - terraform -version
    - terraform init -input=false
    # 먼저 계획만 보고 싶으면 다음 줄 주석 해제:
    # - terraform plan -destroy -input=false
    - terraform destroy -auto-approve
  when: manual
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never
  environment:
    name: production
    action: stop
```

## 구성 설계 이유

### Rules와 Changes 사용
- `rules: changes:` → `terraform/` 변경 없으면 job 자체가 생성되지 않음
- 불필요한 파이프라인 실행 방지로 리소스 절약

### Detailed Exit Code 활용
- `-detailed-exitcode` → 변경 없으면 빠르게 종료
- 0: 변경 없음, 1: 오류, 2: 변경 있음으로 구분

### Apply 단계 분기 로직
- `tfplan` 유무로 분기 처리
- dev와 별개로 main만 실행해도 안전하게 동작

### Manual 실행
- `apply`와 `destroy`는 수동 실행으로 실수 방지
- 필요 시 `on_stop`으로 Environments Stop 버튼 연결 가능

## 사용법

### 1. 개발 (Plan 확인)
```bash
# terraform/ 수정 후
git checkout dev
git add terraform/*
git commit -m "feat(terraform): VM 인스턴스 추가"
git push origin dev
```

> 파이프라인에서 `tf:plan` 자동 실행되어 변경 내역 확인 가능

### 2. 운영 반영 (Apply 실행)
```bash
git checkout main
git merge dev
git push origin main
```

> 파이프라인에서 `tf:apply` **수동 승인** 클릭하여 실행

### 3. 리소스 삭제 (Destroy 실행)
- 파이프라인에서 `tf:destroy` 수동 실행
- (선택) Environments Stop 버튼 사용 시 `tf:apply.environment.on_stop` 주석 해제

## 트러블슈팅

### > 코드 받기 타임아웃 문제
**GitLab 설정 확인**
```bash
# GitLab external_url 확인
sudo gitlab-rails runner 'puts Gitlab.config.gitlab.url'

# Runner clone_url 확인
sudo gitlab-runner list
```

### > OpenStack 인증 오류
**clouds.yaml 경로 및 권한 확인**
```bash
# 파일 존재 및 권한 확인
ls -la ~gitlab-runner/.config/openstack/clouds.yaml
sudo -u gitlab-runner openstack --os-cloud devstack server list
```

**도메인/프로젝트 값 재검토**
```bash
# openrc에서 정확한 값 확인
source /opt/stack/devstack/openrc admin
env | grep OS_
```

### > Apply 실패 (불변 속성 오류)
**Plan에서 재생성 확인**
- Plan 단계에서 Destroy+Create 표시 확인
- 불변 속성 변경 시 리소스 재생성 필요함을 인지

### > State 관리 문제
**원격 State 백엔드 사용 권장**
```hcl
# backend.tf 예시
terraform {
  backend "local" {
    path = "/shared/terraform/terraform.tfstate"
  }
}
```

### > Job 실행되지 않는 문제
**Runner 태그 확인**
- `.gitlab-ci.yml`에서 tags 설정 확인
- Runner 등록 시 설정한 태그와 일치해야 함

**Changes 조건 확인**
- `terraform/` 폴더 내 파일 변경이 있어야 job 실행
- Git diff로 변경 사항 확인

## 고급 설정

### 환경별 분리
```yaml
variables:
  TF_WORKDIR: "terraform"
  TF_VAR_environment: "${CI_COMMIT_BRANCH}"
```

### 승인 프로세스 강화
```yaml
tf:apply:
  # ... 기존 설정
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
```

### 병렬 실행 방지
```yaml
tf:apply:
  # ... 기존 설정
  resource_group: terraform
```

이제 Terraform CI 파이프라인이 구성되었음. 코드 변경 시 자동으로 plan이 실행되고, 수동 승인을 통해 안전하게 인프라를 관리할 수 있음.
