# Phase 4-5: Ansible 자동 실행 CI (GitLab Runner/Shell 기준)

## 개요
Terraform으로 생성된 OpenStack 인프라에 Ansible Playbook을 자동 실행하여 서비스(Nginx, Jenkins, 사용자/방화벽 설정 등)를 배포하는 단계입니다.

**환경**: Shell Executor Runner(mydevstack)  
**관리 방식**: SSH 비밀키와 Inventory를 GitLab Variables로 관리

## 0. 전제 조건 및 사전 준비

### 전제 조건
- Phase 4-4 Terraform CI 파이프라인이 정상 동작 중
- 배포 대상 서버(인스턴스)에 Ansible 접근 가능
- SSH Key 인증 설정 완료
- ansible_user / ansible_host 정보 확인

### 디렉토리 구조
```
repo-root/
├─ ansible/
│   ├─ inventories/
│   │   └─ hosts.ini       # 인벤토리 (또는 CI 변수로 생성)
│   ├─ roles/
│   │   ├─ nginx/
│   │   └─ jenkins/
│   └─ site.yml
└─ .gitlab-ci.yml
```

## 1. GitLab 설정

### 1.1 Protected Branch 설정
- `main` 브랜치는 직접 푸시 금지
- merge 승인 후에만 배포 진행

### 1.2 CI/CD Variables 등록
**경로**: GitLab → Settings → CI/CD → Variables

| 변수명 | 값 | 설명 |
|--------|-----|------|
| `ANSIBLE_PRIVATE_KEY` | id_rsa 내용 전체 | SSH 접속용 키 |
| `ANSIBLE_INVENTORY` | hosts.ini 내용 | Ansible 인벤토리 |
| `ANSIBLE_USER` | 예: ubuntu | 대상 서버 접속 계정 |
| `TF_OUTPUT_HOST` | (선택) Terraform output의 서버 IP | Terraform → Ansible 연동 시 |
| `ANSIBLE_VAULT_PASSWORD` | (선택) Vault 암호 | 민감 변수 암호화 사용 시 |

**보안 설정**: 비밀키, Vault 비밀번호는 반드시 **Masked + Protected**로 설정

## 2. 핵심 전략

### 브랜치 규칙
- `dev` → Ansible Dry-run (--check)
- `main` → 실제 적용

### 파일 생성 전략
- `ANSIBLE_PRIVATE_KEY` → `~/.ssh/id_rsa`
- `ANSIBLE_INVENTORY` → `ansible/inventories/hosts.ini`

### 보안
- Job 종료 후 민감 파일 삭제

### 확장성
- Terraform output을 ansible-playbook 변수로 주입 가능
- 예: `-e "host_ip=$TF_OUTPUT_HOST"`

## 3. .gitlab-ci.yml 구성

```yaml
stages:
  - ansible-check
  - ansible-apply

.default_ansible:
  image: ""  # Shell Executor 환경
  before_script:
    # 1) Ansible 설치
    - |
      if ! command -v ansible >/dev/null 2>&1; then
        echo "[INFO] Installing Ansible..."
        sudo apt-get update -y
        sudo apt-get install -y ansible sshpass
      else
        echo "[INFO] Ansible already installed:"
        ansible --version
      fi
    # 2) SSH 키 생성
    - mkdir -p ~/.ssh
    - echo "$ANSIBLE_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    # 3) Inventory 파일 생성
    - mkdir -p ansible/inventories
    - echo "$ANSIBLE_INVENTORY" > ansible/inventories/hosts.ini
    # 4) Known hosts 무시 설정 (테스트 환경)
    - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
  after_script:
    # 민감 파일 제거
    - shred -u ~/.ssh/id_rsa || true
    - shred -u ansible/inventories/hosts.ini || true

ansible-check:
  stage: ansible-check
  extends: .default_ansible
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev"'
  script:
    - cd ansible
    - ansible-playbook -i inventories/hosts.ini site.yml --check

ansible-apply:
  stage: ansible-apply
  extends: .default_ansible
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  script:
    - cd ansible
    - ansible-playbook -i inventories/hosts.ini site.yml
```

## 4. 주요 포인트

### Runner 환경 그대로 실행
- Shell Executor라 별도 Docker 이미지 불필요

### 민감 정보 CI 변수 관리
- SSH 키/Inventory를 변수로 등록 후 Job에서 생성

### Dry-run & 실제 실행 분리
- `dev` 브랜치 → `--check`
- `main` 브랜치 → 실제 실행

### Terraform 연동 (선택)
- Terraform output 값을 `ANSIBLE_INVENTORY`나 `extra_vars`로 전달 가능

## 5. 수동 apply 승인 방법

1. GitLab → Build → Pipelines → 해당 파이프라인 진입
2. `ansible-apply` Job 옆 Play ▶ 버튼 클릭

## 6. 로컬 테스트 방법

Runner와 동일한 환경에서 실행:

```bash
# SSH 키 저장
mkdir -p ~/.ssh && chmod 700 ~/.ssh
echo "$ANSIBLE_PRIVATE_KEY" > ~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa

# Inventory 저장
mkdir -p ansible/inventories
echo "$ANSIBLE_INVENTORY" > ansible/inventories/hosts.ini

# 실행
cd ansible
ansible-playbook -i inventories/hosts.ini site.yml --check   # Dry-run
ansible-playbook -i inventories/hosts.ini site.yml          # 실제 실행
```

## 7. 트러블슈팅

### 일반적인 문제
- SSH 연결 실패 → 키 권한(600) 및 네트워크 확인
- Inventory 파일 오류 → 변수 내용 및 형식 검증
- Ansible 명령 실패 → 대상 서버 상태 및 권한 확인

### 디버깅 팁
- `ansible-playbook` 실행 시 `-vvv` 옵션으로 상세 로그 확인
- CI 변수 마스킹으로 인한 디버깅 어려움 → 로컬 테스트 활용
