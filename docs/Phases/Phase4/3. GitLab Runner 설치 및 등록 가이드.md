# GitLab Runner 설치 및 등록 가이드

GitLab Runner는 CI/CD 파이프라인을 실행하는 에이전트다. `.gitlab-ci.yml`에 정의된 작업을 실제로 수행하며, GitLab 서버와 지속적으로 통신하여 새로운 작업을 가져와 실행한다.

## 1. GitLab Runner 설치

### 저장소 추가 및 설치
```bash
# 저장소 추가
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash

# 패키지 설치
sudo apt update
sudo apt install gitlab-runner -y

# 설치 확인
gitlab-runner --version
sudo systemctl status gitlab-runner
sudo systemctl enable gitlab-runner
```

> 정상 설치되면 gitlab-runner 서비스가 active 상태로 표시됨

## 2. 토큰 발급

GitLab 웹에서 토큰 생성:
1. GitLab 프로젝트 접속 → Settings → CI/CD → Runners
2. Project runners 섹션에서 우측 상단 점 3개 메뉴 클릭
3. "Reset authentication token" 선택
4. "Create runner" 클릭 후 `glrt-`로 시작하는 토큰 복사

> 토큰은 한 번만 표시되므로 별도 저장 필요

## 3. Runner 등록

### 대화형 등록
```bash
sudo gitlab-runner register
```

프롬프트 입력 예시:
```
GitLab instance URL: http://a.b.c.d:8081
Registration token: glrt-xxxxxxxxxxxxxxxxxxxx
Description: production-runner
Tags: shell,terraform,ansible
Executor: shell
```

### 스크립트 방식 등록
```bash
sudo gitlab-runner register \
  --url "http://a.b.c.d:8081" \
  --token "glrt-xxxxxxxxxxxxxxxxxxxx" \
  --executor "shell" \
  --description "production-runner" \
  --tag-list "shell,terraform,ansible" \
  --run-untagged="true" \
  --non-interactive
```

## 4. 등록 확인 및 테스트

### GitLab 웹에서 확인
프로젝트 → Settings → CI/CD → Runners에서 등록된 Runner 상태 확인

> 상태가 초록색이고 "Last contact"가 최근 시간이면 정상

### CLI 확인
```bash
sudo gitlab-runner list
sudo gitlab-runner status
```

### 테스트 실행
**1) `.gitlab-ci.yml` 파일 생성**
```bash
touch .gitlab-ci.yml
nano .gitlab-ci.yml
```

**2) 내용 입력**
```yaml
test:
  stage: test
  tags:
    - shell
  script:
    - echo "Runner 테스트"
    - whoami
    - pwd
```

**3) 커밋 & 푸시**
```bash
git add .gitlab-ci.yml
git commit -m "Runner 동작 테스트 CI 추가"
git push origin dev
```

**4) GitLab에서 파이프라인 확인**
- Build → Pipelines에서 상태 확인
- Job 클릭하여 실행 로그 확인

## 5. 파이프라인 재실행 방법

### 방법 1: 빈 커밋으로 트리거
```bash
git commit --allow-empty -m "ci: trigger pipeline"
git push origin dev
```
> 코드 변경 없이 새 커밋 해시만 생성하여 파이프라인 실행

### 방법 2: GitLab UI에서 직접 실행
- CI/CD → Pipelines → `Run pipeline` 버튼 클릭
- 또는 기존 파이프라인 → `Retry` / `Rerun pipeline` 버튼 클릭

> 로컬에서 커밋/푸시 필요 없음

## 6. 설정 관리

### 설정 파일 확인
```bash
sudo cat /etc/gitlab-runner/config.toml
```

### 주요 설정 옵션
```toml
concurrent = 1  # 동시 실행 가능한 작업 수
check_interval = 0

[[runners]]
  name = "production-runner"
  url = "http://a.b.c.d:8081"
  token = "glrt-xxxxxxxxxxxxxxxxxxxx"
  executor = "shell"
  limit = 2  # 해당 Runner가 실행할 수 있는 최대 작업 수
  run_untagged = true  # 태그가 없는 작업도 실행할지 여부
```

## 7. 서비스 관리

### 서비스 제어
```bash
sudo systemctl start gitlab-runner
sudo systemctl stop gitlab-runner
sudo systemctl restart gitlab-runner
sudo systemctl status gitlab-runner
```

### Runner 관리
```bash
sudo gitlab-runner list              # Runner 목록 확인
sudo gitlab-runner verify            # 설정 검증
sudo gitlab-runner unregister --name "runner-name"  # 특정 Runner 등록 해제
```

## 트러블슈팅

### > Job이 실행되지 않는 경우

**Runner 태그 확인**
- `.gitlab-ci.yml`의 `tags` 항목과 Runner 등록 시 설정한 태그가 일치해야 함

**Runner 상태 확인**
```bash
sudo gitlab-runner status
sudo journalctl -u gitlab-runner --since "10 minutes ago"
```

**GitLab 서버 연결 확인**
```bash
curl -I http://a.b.c.d:8081
```

### > 잘못 등록된 Runner 문제

예전(잘못 등록된) Runner가 작업을 가져가는 경우

**GitLab 서버 URL 수정 (권장)**
```bash
sudo vim /etc/gitlab/gitlab.rb

# 실제 접속하는 주소/포트로 변경
external_url 'http://a.b.c.d:8081'

# GitLab 재구성
sudo gitlab-ctl reconfigure

# 설정 확인
sudo gitlab-rails runner 'puts Gitlab.config.gitlab.url'
```

### > 권한 문제

**gitlab-runner 사용자 권한 부여**
```bash
sudo usermod -aG sudo gitlab-runner                              # sudo 권한
sudo chown -R gitlab-runner:gitlab-runner /path/to/project       # 디렉토리 접근 권한
sudo usermod -aG docker gitlab-runner                            # Docker 사용 권한
```

### > 토큰 만료

**토큰 재등록**
```bash
sudo gitlab-runner unregister --name "old-runner"
# GitLab에서 새 토큰 발급 후 재등록
sudo gitlab-runner register
```

### > 네트워크 문제

**연결 확인**
```bash
telnet a.b.c.d 8081    # 포트 연결 확인
sudo ufw status        # 방화벽 상태 확인
```

## Executor 타입 선택

### Shell Executor (권장)
- 호스트 시스템에서 직접 명령어 실행
- Terraform, Ansible 등 인프라 도구 사용에 적합
- 설정이 간단하고 호스트의 모든 도구 사용 가능

### Docker Executor
- Docker 컨테이너에서 작업 실행
- 작업마다 깨끗한 환경 제공, 보안성 높음
- Docker 설치 및 설정 필요

> 인프라 자동화 프로젝트에서는 대부분 Shell Executor 사용

## 보안 및 백업

### 설정 파일 백업
```bash
sudo cp /etc/gitlab-runner/config.toml /backup/gitlab-runner-config-$(date +%Y%m%d).toml
```

### 복구
```bash
sudo cp /backup/gitlab-runner-config-20231201.toml /etc/gitlab-runner/config.toml
sudo systemctl restart gitlab-runner
```
