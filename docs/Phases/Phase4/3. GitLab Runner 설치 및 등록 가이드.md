# GitLab Runner 설치 및 등록 가이드

## 개요

GitLab Runner는 CI/CD 파이프라인을 실행하는 에이전트다. `.gitlab-ci.yml`에 정의된 작업을 실제로 수행하며, GitLab 서버와 지속적으로 통신하여 새로운 작업을 가져와 실행한다.

---

## 1. GitLab Runner 설치

### 1.1 저장소 추가

```bash
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash
```

### 1.2 패키지 설치

```bash
sudo apt update
sudo apt install gitlab-runner -y
```

### 1.3 설치 확인

```bash
gitlab-runner --version
sudo systemctl status gitlab-runner
sudo systemctl enable gitlab-runner
```

정상 설치되면 gitlab-runner 서비스가 active 상태로 표시된다.

---

## 2. 토큰 발급

GitLab 프로젝트에서 Runner 등록용 토큰을 발급받아야 한다.

### 2.1 GitLab 웹에서 토큰 생성

1. GitLab 프로젝트 접속
2. Settings → CI/CD → Runners 메뉴
3. Project runners 섹션에서 우측 상단 점 3개 메뉴 클릭
4. "Reset authentication token" 선택
5. "Create runner" 클릭 후 표시되는 `glrt-` 로 시작하는 토큰 복사

토큰은 한 번만 표시되므로 별도 저장해둘 것.

---

## 3. Runner 등록

### 3.1 대화형 등록

```bash
sudo gitlab-runner register
```

프롬프트에 따라 입력:
```
GitLab instance URL: http://<host.ip>:8081
Registration token: glrt-xxxxxxxxxxxxxxxxxxxx
Description: production-runner
Tags: shell,terraform,ansible
Executor: shell
```

### 3.2 스크립트 방식 등록

```bash
sudo gitlab-runner register \
  --url "http://<host.ip>:8081" \
  --token "glrt-xxxxxxxxxxxxxxxxxxxx" \
  --executor "shell" \
  --description "production-runner" \
  --tag-list "shell,terraform,ansible" \
  --run-untagged="true" \
  --non-interactive
```

---

## 4. 등록 확인

### 4.1 GitLab 웹에서 확인

프로젝트 → Settings → CI/CD → Runners에서 "Available specific runners" 목록에 등록된 Runner가 표시된다. 상태가 초록색이고 "Last contact"가 최근 시간으로 표시되면 정상이다.

### 4.2 CLI에서 확인

```bash
sudo gitlab-runner list
sudo gitlab-runner status
```

### 4.3 테스트 실행 (Runner 동작 확인)

**1. `.gitlab-ci.yml` 파일 만들기**

```bash
touch .gitlab-ci.yml
nano .gitlab-ci.yml
```

**2. 내용 입력**

```yaml
test:
  stage: test
  tags:
    - shell  # Runner 등록 시 사용한 태그와 동일해야 함
  script:
    - echo "Runner 테스트"
    - whoami
    - pwd
```

태그를 지정하지 않고 Runner를 등록했다면 `tags:` 줄은 삭제해도 된다.
`Ctrl + O` → `Enter` → `Ctrl + X`로 저장 & 나가기

**3. GitLab에 커밋 & 푸시**

```bash
git add .gitlab-ci.yml
git commit -m "Runner 동작 테스트 CI 추가"
git push origin main
```

`main` 대신 현재 사용하는 브랜치 이름 입력

**4. GitLab에서 파이프라인 실행 확인**

`.gitlab-ci.yml`이 실행됐는지는 GitLab 프로젝트에서 이렇게 확인하면 된다.

1. **파이프라인 목록 확인**
   - 프로젝트 페이지 접속
   - 왼쪽 메뉴 Build → Pipelines 클릭
   - 방금 푸시한 커밋이 목록에 있고 상태가 Running 또는 Passed면 실행된 것

2. **로그 확인**
   - `test` Job 클릭하면 실행 로그가 표시된다
   - 정상 실행되면 다음과 같이 출력된다:

```
Runner 테스트
gitlab-runner
/home/gitlab-runner/builds/...
```

---

##  설정 관리

###  설정 파일 위치

```bash
sudo cat /etc/gitlab-runner/config.toml
```

###  주요 설정 옵션

```toml
concurrent = 1
check_interval = 0

[[runners]]
  name = "production-runner"
  url = "http://<host.ip>:8081"
  token = "glrt-xxxxxxxxxxxxxxxxxxxx"
  executor = "shell"
  limit = 2
  run_untagged = true
  
  [runners.shell]
    shell = "bash"
```

**주요 설정:**
- `concurrent`: 동시 실행 가능한 작업 수
- `limit`: 해당 Runner가 실행할 수 있는 최대 작업 수
- `run_untagged`: 태그가 없는 작업도 실행할지 여부

---

## Executor 타입

### Shell Executor (일반적으로 사용)

가장 간단한 방식. 호스트 시스템에서 직접 명령어를 실행한다.

**장점:**
- 설정이 간단함
- 호스트의 모든 도구와 환경 변수 사용 가능
- Terraform, Ansible 등 인프라 도구 사용에 적합

**단점:**
- 작업 간 환경 오염 가능성
- 보안성 낮음

### Docker Executor

Docker 컨테이너에서 작업을 실행한다.

**장점:**
- 작업마다 깨끗한 환경 제공
- 다양한 언어/도구 환경 구성 가능
- 보안성 높음

**단점:**
- Docker 설치 및 설정 필요
- 호스트 파일시스템 접근 제한

인프라 자동화 프로젝트에서는 대부분 Shell Executor를 사용한다.

---

## 서비스 관리

### 서비스 제어

```bash
# 서비스 제어
sudo systemctl start gitlab-runner
sudo systemctl stop gitlab-runner
sudo systemctl restart gitlab-runner

# 상태 확인
sudo systemctl status gitlab-runner

# 로그 확인
sudo journalctl -u gitlab-runner -f
```

### Runner 관리

```bash
# Runner 목록 확인
sudo gitlab-runner list

# 특정 Runner 등록 해제
sudo gitlab-runner unregister --name "runner-name"

# 모든 Runner 등록 해제
sudo gitlab-runner unregister --all-runners

# 설정 검증
sudo gitlab-runner verify
```

---

## 문제 해결

### Job이 실행되지 않는 경우

**1) Runner 태그와 Job 태그 일치 확인**
`.gitlab-ci.yml`의 `tags` 항목과 Runner 등록 시 설정한 태그가 일치해야 한다.

**2) Runner 상태 확인**
```bash
sudo gitlab-runner status
sudo journalctl -u gitlab-runner --since "10 minutes ago"
```

**3) GitLab 서버 연결 확인**
```bash
curl -I http://<host.ip>:8081
```

### 권한 문제

gitlab-runner 사용자에게 필요한 권한을 부여한다:

```bash
# sudo 권한 부여
sudo usermod -aG sudo gitlab-runner

# 특정 디렉토리 접근 권한
sudo chown -R gitlab-runner:gitlab-runner /path/to/project

# Docker 사용 권한 (Docker Executor 사용 시)
sudo usermod -aG docker gitlab-runner
```

### 토큰 만료

토큰이 만료되거나 변경된 경우:

```bash
sudo gitlab-runner unregister --name "old-runner"
# GitLab에서 새 토큰 발급 후 재등록
sudo gitlab-runner register
```

### 네트워크 문제

```bash
# 포트 확인
telnet <host.ip> 8081

# 방화벽 상태 확인
sudo ufw status
```

---

## 성능 최적화

### 동시 실행 작업 수 조정

`/etc/gitlab-runner/config.toml`에서 `concurrent` 값을 조정한다. CPU 코어 수와 메모리를 고려하여 설정한다.

```toml
concurrent = 2  # 2개 작업 동시 실행
```

### 로그 레벨 조정

디버깅이 필요한 경우:

```bash
sudo gitlab-runner run --debug
```

---

## 보안 및 백업

### 보안 고려사항

- Runner 토큰은 안전하게 보관하고 정기적으로 교체
- 프로덕션 환경에서는 전용 Runner 서버 사용
- gitlab-runner 사용자 권한을 최소한으로 제한
- 민감한 정보는 GitLab CI/CD 변수로 관리

### 백업 및 복구

**설정 파일 백업:**
```bash
sudo cp /etc/gitlab-runner/config.toml /backup/gitlab-runner-config-$(date +%Y%m%d).toml
```

**복구:**
```bash
sudo cp /backup/gitlab-runner-config-20231201.toml /etc/gitlab-runner/config.toml
sudo systemctl restart gitlab-runner
```

이제 GitLab Runner가 설치되고 등록되었다. CI/CD 파이프라인이 정상적으로 실행되는지 간단한 테스트 Job으로 확인해보자.
