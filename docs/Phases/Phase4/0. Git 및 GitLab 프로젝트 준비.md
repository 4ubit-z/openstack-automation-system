# Phase 4-0: Git 및 GitLab 프로젝트 준비

## 목표

* GitLab 서버 설치 및 접근 확인
* Git 기본 개념 이해 및 브랜치 전략 수립
* GitLab 프로젝트 생성 및 Git 연동
* 브랜치 기반 개발 워크플로우 확립
* `.gitlab-ci.yml` 자동화를 위한 기반 구축

---

## 0. GitLab 서버 설치 및 접속 확인

### 0.1 사전 준비

| 항목 | 권장 설정 |
|------|-----------|
| OS | Ubuntu 20.04 또는 22.04 |
| GitLab 포트 | 8081 |
| 도메인/IP | 외부에서 접근 가능한 브릿지 IP |
| 인스턴스명 | GitLab용 별도 Ubuntu VM (DevStack 외부에서 설치) |

### 0.2 GitLab 설치

```bash
# 필수 패키지 설치
sudo apt update
sudo apt install -y curl openssh-server ca-certificates tzdata perl

# GitLab 저장소 등록
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash

# GitLab 설치 (외부 접속용 포트 설정)
sudo EXTERNAL_URL="http://<your-ip>:8081" apt install gitlab-ce
```

**주의**: `EXTERNAL_URL`에는 브릿지 IP 또는 공인 IP 입력

### 0.3 포트 개방 및 확인

* OpenStack 보안 그룹에서 8081 포트 허용
* 공유기 사용 시 포트포워딩 설정 필요 (8081 → 해당 VM)

```bash
# 포트 확인
sudo ss -tuln | grep 8081
```

### 0.4 초기 접속

```bash
# 초기 root 비밀번호 확인
sudo cat /etc/gitlab/initial_root_password
```

**접속 단계**:
1. 웹 브라우저 접속: `http://<your-ip>:8081`
2. root 계정으로 로그인
3. 비밀번호 변경
4. 관리자 설정 완료

---

## 1. Git 기본 개념 정리

### 1.1 Git이란?

* **분산 버전 관리 시스템**
* 커밋 단위로 변경사항 추적
* 브랜치로 실험/개발 분리 가능

### 1.2 브랜치 개념

* `main`: 메인 브랜치
* `feature/terraform-setup`: 기능 개발용
* `fix/nginx-port`: 버그 수정

### 1.3 Checkout 명령어

```bash
git checkout <브랜치>     # 브랜치 이동
git checkout -b <브랜치>  # 브랜치 생성 + 이동
```

### 1.4 브랜치 네이밍 컨벤션

| 타입 | 용도 | 예시 |
|------|------|------|
| `feature/` | 기능 개발 | `feature/user-auth` |
| `fix/` | 버그 수정 | `fix/login-error` |
| `chore/` | 기타 잡일 | `chore/update-readme` |

---

## 2. GitLab 프로젝트 생성 및 연동

### 2.1 GitLab에서 프로젝트 생성

**웹 인터페이스 단계**:
1. 접속: `http://<your-ip>:8081`
2. 로그인: root 계정
3. 상단 메뉴 → **New project**
4. **Create blank project**
   * Project name: `openstack-auto`
   * Visibility: Private
   * Create 클릭

### 2.2 Git 프로젝트 초기화

```bash
cd ~/openstack-auto
git init

touch README.md .gitignore
echo "# OpenStack 자동화 프로젝트" > README.md
echo ".terraform/" >> .gitignore
echo "*.tfstate*" >> .gitignore
echo "*.tfplan" >> .gitignore
echo "*.backup" >> .gitignore
```

### 2.3 원격 저장소 연결

```bash
git remote add origin http://<your-ip>:8081/root/openstack-auto.git
git remote -v
```

### 2.4 첫 커밋 및 푸시

```bash
git add .
git commit -m "init: initial project setup"
git push -u origin main
```

**주의**: main 브랜치 보호 중일 경우 실패 가능

---

## 3. 브랜치 기반 개발 전략

### 3.1 기능 브랜치 생성

```bash
git checkout -b feature/terraform-setup
```

### 3.2 작업 후 커밋

```bash
git add .
git commit -m "feat: Terraform 인프라 코드 작성

- OpenStack provider 설정
- 인스턴스 리소스 정의
- 보안 그룹 구성"
```

### 3.3 원격 브랜치 푸시

```bash
git push -u origin feature/terraform-setup
```

### 3.4 Merge Request 생성

**GitLab 웹 인터페이스**:
1. GitLab 웹 → `Merge Requests` → `New merge request`
2. Source: `feature/terraform-setup`
3. Target: `main`
4. Create → Merge

---

## 4. Personal Access Token 설정 (선택)

### 4.1 생성 방법

1. GitLab 접속 → 우측 상단 → Edit profile
2. 좌측 메뉴 → Access Tokens
3. 설정값:
   * Name: `ci-token`
   * Scopes: `api`, `read_repository`, `write_repository`
4. **생성된 토큰은 한 번만 표시됨 → 따로 저장**

### 4.2 사용 예시

```bash
git clone https://oauth2:<token>@<your-ip>:8081/root/openstack-auto.git
```

---

## 5. Git 워크플로우 요약

### 5.1 일반적인 개발 플로우

```bash
# main 브랜치 최신화
git checkout main
git pull origin main

# 브랜치 생성
git checkout -b feature/xyz

# 작업 후 푸시
git add .
git commit -m "feat: ~"
git push -u origin feature/xyz

# 병합 후 정리
git checkout main
git pull origin main
git branch -d feature/xyz
```

### 5.2 커밋 메시지 컨벤션

| 타입 | 설명 | 예시 |
|------|------|------|
| `init:` | 프로젝트 초기화 | `init: initial project setup` |
| `feat:` | 새로운 기능 | `feat: 사용자 인증 기능 추가` |
| `fix:` | 버그 수정 | `fix: 로그인 오류 해결` |
| `docs:` | 문서 수정 | `docs: README 업데이트` |
| `chore:` | 기타 작업 | `chore: 의존성 업데이트` |

---

## 6. 문제 해결 가이드

### 6.1 자주 발생하는 문제

| 문제 | 해결 방법 |
|------|-----------|
| main 브랜치 푸시 안 됨 | Merge Request 방식 사용 |
| IP 변경으로 접속 안 됨 | 브릿지 IP 재확인 또는 DDNS 설정 |
| 인증 오류 발생 | Personal Access Token 사용 |

### 6.2 GitLab 서비스 관리

```bash
# GitLab 상태 확인
sudo gitlab-ctl status

# GitLab 재시작
sudo gitlab-ctl restart

# 설정 파일 재설정
sudo gitlab-ctl reconfigure

# 로그 확인
sudo gitlab-ctl tail
```

### 6.3 유용한 Git 명령어

```bash
# 브랜치 목록 확인
git branch -a

# 현재 상태 확인
git status

# 커밋 히스토리 확인
git log --oneline

# 변경사항 확인
git diff

# 원격 저장소 정보 확인
git remote -v

# 마지막 커밋 수정
git commit --amend
```

---

## 7. 다음 단계 준비

### 7.1 Terraform 코드 준비

다음 Phase에서 사용할 디렉토리 구조:

```
openstack-auto/
├── terraform/
│   ├── main.tf
│   ├── variables.tf
│   ├── outputs.tf
│   └── terraform.tfvars
├── scripts/
│   └── install-docker.sh
├── .gitlab-ci.yml
├── README.md
└── .gitignore
```

### 7.2 CI/CD 파이프라인 기본 구조

`.gitlab-ci.yml` 파일에 포함될 주요 스테이지:

```yaml
stages:
  - validate
  - plan
  - apply
  - deploy
```

### 7.3 보안 고려사항

* Personal Access Token 보안 관리
* Terraform 상태 파일 보호
* 민감한 정보를 variables나 secrets로 관리
* 브랜치 보호 규칙 설정

---

**완료 확인**:
- GitLab 서버 접속 가능
- Git 프로젝트 생성 및 연동 완료
- 브랜치 기반 개발 워크플로우 이해
- Personal Access Token 생성 (필요시)
- 다음 Phase를 위한 기본 구조 준비 완료

**다음 Phase**: Terraform을 사용한 OpenStack 인프라 코드 작성 및 CI/CD 파이프라인 구축
